<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Infinite - 我的猿问列表</title>
    <meta name="description" content="Admin, Dashboard, Bootstrap, Bootstrap 4, Angular, AngularJS" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="import" href="/common/depjs.html" />
    <link rel="import" href="/common/depcss.html" />
    <link rel="import" href="/common/form-js.html" />
    <script src="/temp1/plugins/bootstrap-sweetalert/sweet-alert.min.js"></script><!-- Sweet-Alert  -->
    <script src="/temp1/assets/pages/jquery.sweet-alert.init.js"></script>
    <script src="/core/bootstrap/js/bootstrap-paginator.js"></script>

    <link rel="stylesheet" href="/temp1/plugins/tooltipster/tooltipster.bundle.min.css">
    <link rel="stylesheet" href="/temp1/plugins/summernote/summernote.css"/><!-- Summernote富文本框 css -->

    <link rel="stylesheet" href="/tools/zTree_v3/css/demo.css" type="text/css">
    <link rel="stylesheet" href="/tools/zTree_v3/css/awesomeStyle/awesome.css" type="text/css">

    <script src="/temp1/plugins/summernote/summernote.min.js"></script><!-- Summernote富文本框 JS -->
    <script src="/temp1/plugins/bootstrap-sweetalert/sweet-alert.min.js"></script><!-- Sweet-Alert  -->
    <script src="/temp1/assets/pages/jquery.sweet-alert.init.js"></script>

    <script type="text/javascript" src="/tools/zTree_v3/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/tools/zTree_v3/js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/tools/zTree_v3/js/jquery.ztree.exedit.js"></script>

    <script src="/temp1/plugins/tooltipster/tooltipster.bundle.min.js"></script>
    <script src="/temp1/assets/pages/jquery.tooltipster.js"></script>
    <script type="text/javascript">
    var TreeUtils = {
        addCount : 1,
        zTree : {},
        rMenu : {},
        setting : {},
        zNodes :[],
        treeId : "",

        init : function (treeId,menuId,setting,zNodes) {

            $.fn.zTree.init($("#"+treeId), setting, zNodes);

            TreeUtils.zNodes = zNodes;
            TreeUtils.setting = setting;
            TreeUtils.zTree = $.fn.zTree.getZTreeObj(treeId);
            TreeUtils.rMenu = $("#"+menuId);
            TreeUtils.treeId = treeId;
        },

        OnRightClick : function (event, treeId, treeNode){
            var zTree = TreeUtils.zTree;
            if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
                zTree.cancelSelectedNode();
                TreeUtils.showRMenu("root", event.clientX, event.clientY);
            } else if (treeNode && !treeNode.noR) {
                zTree.selectNode(treeNode);
                TreeUtils.showRMenu("node", event.clientX, event.clientY);
            }
        },
        showRMenu : function (type, x, y){
            $("#rMenu ul").show();
            if (type=="root") {
                $("#m_del").hide();
                $("#m_check").hide();
                $("#m_unCheck").hide();
            } else {
                $("#m_del").show();
                $("#m_check").show();
                $("#m_unCheck").show();
            }

            y += document.body.scrollTop;
            x += document.body.scrollLeft;
            TreeUtils.rMenu.css({"top":y+"px", "left":x+"px", "visibility":"visible"});

            $("body").bind("mousedown", TreeUtils.onBodyMouseDown);
        },
        hideRMenu : function () {
            if (TreeUtils.rMenu) TreeUtils.rMenu.css({"visibility": "hidden"});
            $("body").unbind("mousedown", TreeUtils.onBodyMouseDown);
        },
        onBodyMouseDown : function () {
            if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length>0)) {
                TreeUtils.rMenu.css({"visibility" : "hidden"});
            }
        }
    }
    </script>
    <style type="text/css">
        div#rMenu {position:absolute; visibility:hidden; top:0; background-color: #555;text-align: left;padding: 2px;}
        div#rMenu ul li{
            margin: 1px 0;
            padding: 0 5px;
            cursor: pointer;
            list-style: none outside none;
            background-color: #DFDFDF;
        }
    </style>
</head>
    <div class="note-tree-menu">
        <div style="margin: 5px 5px 5px 5px;overflow-y:hidden;">
            <span style="font-size: 1px;color: #b1b5b8;margin: 5px 0 5px 5px;">常用</span>
            <ul id="quickTree" class="ztree" style="overflow-y:hidden"></ul>
        </div>
        <div style="margin: 5px 5px 5px 5px;">
            <span style="font-size: 1px;color: #b1b5b8;margin: 5px 0 5px 5px;">知识树</span>
            <a href="javascript:controlTreeFun()" style="color: #b1b5b8;margin-left:150px;"><i id="lock-icon" class="mdi mdi-lock-outline"></i></a>
        </div>
        <div id="treeDiv">
            <ul id="treeDemo" class="ztree" style="overflow: hidden;margin: 5px 5px 5px 5px;"></ul>
            <div id="noTreeStruct" style="margin: 5px 5px 5px 5px;" hidden>
                <button class="btn btn-rounded btn-default waves-effect waves-light"
                        style="margin:50px 50px 50px 50px " onclick="addTree()">
                    <i class="mdi mdi-plus"></i>
                    <span style="font-size:x-small">新建主题</span>
                </button>
            </div>
            <div id="noTreeInfo" style="margin: 5px 5px 5px 5px;" hidden>
                <span style="font-size: 1px;color:#afb4b7;margin:20px;">您还没有创建任何知识树<br></span>
                <span style="font-size: 1px;color:#afb4b7;margin:20px;">请先前往【我的知识树】创建分支</span>
            </div>
        </div>
    </div>
    <div class="note-atc-menu">
        <div style="margin-right: 3px;height: calc(100vh);background-color: white;">
            <div style="height:30px;background-color: rgb(235, 235, 235);border:0px;">
                <button class="btn btn-rounded btn-default waves-effect waves-light" style="margin:3px 0px 3px 3px " onclick="addAtc()">
                    <i class="mdi mdi-plus"></i>
                    <span style="font-size:x-small">新建笔记</span>
                </button>
            </div>
            <div style="height: calc(100vh - 30px);overflow:auto;overflow-y:hidden;">
                <ul id="atc-menu-ul" class="list-group note-atc-menu-ul" >
                    <div id="atcListDiv"></div>
                </ul>
            </div>
        </div>
    </div>
    <div class="note-content">
        <div id="atcDiv"></div>
    </div>

<div id="rMenu">
    <ul>
        <li id="m_add" onclick="addTreeNode();">增加节点</li>
        <li id="m_del" onclick="removeTreeNode();">删除节点</li>
        <li id="m_edit" onclick="editTreeNode();">修改节点</li>
    </ul>
</div>
</body>
<script type="text/javascript">
    var setting = {
        view: {
            selectedMulti: false
        },
        check: {
            enable: false
            ,chkStyle: 'radio'
            ,radioType: "level"
        },
        data: {
            simpleData: {
                enable: true,
                pIdKey: "parentId",
                rootPId: 0
            }
        },
        edit: {
            enable: true
        },
        callback: {
            onRightClick: TreeUtils.OnRightClick,
            onRemove: afterRemove,
            onClick : getDetailList,
            onRename : onRename,
            onDrop: zTreeOnDrop
        }
    };

    var setting_lock = {
        view: {
            selectedMulti: false
        },
        data: {
            simpleData: {
                enable: true,
                pIdKey: "parentId",
                rootPId: 0
            }
        },
        callback: {
            onClick : getDetailList
        }
    };

    var settingTools = {
        view: {
            selectedMulti: false
        },
        data: {
            simpleData: {
                enable: true
            }
        }
    };

    var zNodes = [];
    var zNodesTools =[
        { id:1, pId:0, name:"消息中心",click:"quick()"},
        { id:2, pId:0, name:"选择知识树",click:"quick()"},
        { id:3, pId:0, name:"快捷方式", open:false},
        { id:31, pId:3, name:"pNode 11",click:"quick()"}
    ];

    function quick(){

    }

    var controlTree = 0;//0-锁 1-开
    $(function(){
        /*****弹框初始化******/
        $('[data-toggle="popover"]').popover({html : true });

        /*****知识树初始化******/
        initTree(0);

        $("#atc-menu-ul").slimScroll({
            width: 'auto', //可滚动区域宽度
            height: $(document.body).height() - 30 //可滚动区域高度
        });
        $("#treeDiv").slimScroll({
            width: 'auto', //可滚动区域宽度
            height: $(document.body).height() - 170 //可滚动区域高度
        });
    });

    /*****滚动条插件******/
    function setScroll(){
        $("#atc-menu-ul").slimScroll({
            alwaysVisible: true
        });
        $("#treeDiv").slimScroll({
            alwaysVisible: true
        });
    }
    $(window).on("resize",setScroll);

    /****点击文章，获取文章详情*****/
    var CurAtc = {};//当前文章
    var CurCode = {};//当前代码
    var CurAsk = {};//当前猿问
    var CurType = 1;//当前文章类型
    function getAtc(domId,atcId,type){
        $("li").css("border-color","#ddd");
        $("#"+domId).css("border-color","#6addbb");

        var url = Const.Api_URL + "/MyNoteController/getAtc";
        View.get(url,"atcId="+atcId+"&type="+type,function(resp){
            CurType = type;
            var content = "";
            if(type == 1){
                CurAtc = resp;
                content = resp.tatcContent.htmlContent;
            }else if(type == 2){
                CurAsk = resp;
            }else if(type == 3){
                CurCode = resp;
            }
            frushAtcTmpl();

            /*****编辑器初始化******/
            $('.summernote').summernote({
                height: $(document.body).height() - 130,                 // set editor height
                minHeight: null,             // set minimum height of editor
                maxHeight: null,             // set maximum height of editor
                focus: false                 // set focus to editable area after initializing summernote
            });
            $('.inline-editor').summernote({
                airMode: false
            });

            $('.summernote').summernote('code',content);

            /*****预览模式初始化******/
            $('.note-toolbar').hide();
            $('.summernote').summernote('disable');

        },function(){

        });
    }

    /****编辑/预览 按钮*****/
    var editFlag = 0    ;// 0-预览模式 1-编辑模式
    function hideToolbar() {
        if(editFlag == 1){//开启预览模式+保存
            $('.note-toolbar').hide();
            $('.summernote').summernote('disable');
            $("#atcDesc").show();
            $("#titleInfo").attr("readOnly",true);
            editFlag = 0;
            //将内容存入数据库
            $('.summernote').summernote('code');
            if(CurType == 1){
                CurAtc.titleInfo = $("#titleInfo").val();
                CurAtc.tatcContent.htmlContent = $('.summernote').summernote('code');
                var url = Const.Api_URL + "/AtcController/saveAtc";
                View.post(url,CurAtc,function(resp){
                    swal({title:"保存成功",text:"",showConfirmButton: false,
                        showCancelButton: false, timer:1500,type:"success"});
                },function(){

                });
            }else if(CurType == 2){

            }else if(CurType == 3) {

            }
        }else{//开启编辑模式
            $('.note-toolbar').show();
            $('.summernote').summernote('enable');
            $("#atcDesc").hide();
            $("#titleInfo").attr("readOnly",false);
            editFlag = 1;
        }
    }

    /****新建笔记*****/
    function addAtc(){
        var newDetail = {};
        newDetail.authorId = Author.id;
        newDetail.authorName = Author.name;
        newDetail.treeId = CurTreeId;
        newDetail.mId = CurNode.id;
        newDetail.titleInfo = "新笔记";
        newDetail.description = "还未添加描述。。。";
        newDetail.createTime = new Date();
        CurDetailList = prepend(CurDetailList,newDetail);
        //刷新列表
        frushDetailTmpl();
        //第一个选中
        $("li").css("border-color","#ddd");
        $("#li_0").css("border-color","#6addbb");
        //刷新右边文章显示（暂时默认新增的是手记录）
        CurType = 1;
        CurAtc.titleInfo = "";
        CurAtc.description = "还未添加描述。。。";
        CurAtc.tatcContent = {};
        CurAtc.tatcContent.htmlContent = "";
        frushAtcTmpl();


        /*****编辑器初始化******/
        $('.summernote').summernote({
            height: $(document.body).height() - 130,                 // set editor height
            minHeight: null,             // set minimum height of editor
            maxHeight: null,             // set maximum height of editor
            focus: false                 // set focus to editable area after initializing summernote
        });
        $('.inline-editor').summernote({
            airMode: false
        });
        /*****预览模式初始化******/
        $('.note-toolbar').hide();
        $('.summernote').summernote('disable');
        hideToolbar();

        var url = Const.Api_URL + "/MyNoteController/addDetail";
        View.post(url,newDetail,function(resp){
            CurAtc = resp;

        },function(){

        });
    }

    /*****刷新文章列表*******/
    function frushDetailTmpl (){
        var data = {};
        data.list = CurDetailList;
        var	gettype=Object.prototype.toString;
        for(var i=0;i<data.list.length;i++){
            if(gettype.call(data.list[i].createTime).indexOf("Number")>-1){
                data.list[i].createTime = getMyDate(parseInt(data.list[i].createTime));
            }
        }
        var temp = new Tmpl("atcListTmpl",data);
        temp.reset("atcListDiv");
    }

    function frushAtcTmpl(){
        var data = {};
        data.data = CurAtc;
        var	gettype=Object.prototype.toString;
        if(gettype.call(data.data.createTime).indexOf("Number")>-1) {
            data.data.createTime = getMyDate(parseInt(data.data.createTime));
        }
        var temp = new Tmpl("atcTmpl",data);
        temp.reset("atcDiv");
    }

    var TreeInfoList = [];//当前用户知识树列表
    var CurTreeStructure = [];//当前树结构体
    var CurTreeId;//当前知识树ID
    var CurDetailList = [];//当前文章列表
    var CurNode = {};//当前点击节点信息

    /****初始化树结构*****/
    function initTree(cFlag){
        //初始化常用栏
        $.fn.zTree.init($("#quickTree"), settingTools, zNodesTools);

        //初始化知识树栏
        //获取用户知识树列表
        var url = Const.Api_URL + "/MyNoteController/getMyTreeInfomation";
        var param =  "authorId=" + Author.id;
        View.get(url,param,function(infoResp){
            TreeInfoList = infoResp;
            if(!!infoResp[0]){
                //获取知识树结构
                url = Const.Api_URL + "/MyNoteController/getTreeStructure";
                param =  "treeId=" + infoResp[0].id;
                CurTreeId = infoResp[0].id;
                View.get(url,param,function(structureResp){
                    if(structureResp==null||structureResp.length==0){
                        //没有知识树结构,显示新增按钮
                        $("#treeDemo").hide();
                        $("#noTreeStruct").show();
                    }else{
                        CurTreeStructure = structureResp;
                        //zNodes = initZNodes(structureResp);
                        if(cFlag == 0){
                            //锁住
                            TreeUtils.init("treeDemo","rMenu",setting_lock,structureResp);
                        }else{
                            TreeUtils.init("treeDemo","rMenu",setting,structureResp);
                        }
                    }
                },function(){

                });
            }else{
                $("#treeDemo").hide();
                $("#noTreeStruct").hide();
                $("#noTreeInfo").show();
            }
        },function(){

        });
    }

    /**新建知识树**/
    function addTree(){
        //增加树结构
        var url = Const.Api_URL + "/MyNoteController/addTreeStructure";
        var treeStructure = {};
        treeStructure.treeId = CurTreeId;
        treeStructure.parentId = 0;
        treeStructure.name = "新主题";
        View.post(url,treeStructure,function(structureResp){
            $("#treeDemo").show();
            $("#noTreeStruct").hide();
            TreeUtils.init("treeDemo","rMenu",setting,structureResp);
            CurTreeStructure.push(structureResp);
        },function(){
            swal({title:"新建主题失败",text:"请联系管理员。",showConfirmButton: false,
                showCancelButton: false, timer:1500,type:"fail"});
        });
    }

    /*****修改节点名称*******/
    function onRename(event, treeId, treeNode, isCancel){
        if(!isCancel){//修改了
            var structure = {};
            structure.name = treeNode.name;
            structure.parentId = treeNode.parentId;
            structure.id = treeNode.id;
            structure.treeId = CurTreeId;
            var url = Const.Api_URL + "/MyNoteController/updateStruct";
            View.post(url,structure,function(resp){

            },function(){

            });
        }
    }

    /*****删除节点之后，如果没有节点，显示新增主题*******/
    function afterRemove(event, treeId, treeNode){
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
        var nodes = treeObj.getNodes();
        //如果没有节点，显示新增主题
        if(nodes==null||nodes.length==0){
            $("#treeDemo").hide();
            $("#noTreeStruct").show();
            zNodes=[];
        }
        //更新下数据库
        var url = Const.Api_URL + "/MyNoteController/deleteStruct";
        View.get(url,"id="+treeNode.id,function(){
            for(var i=0;i<CurTreeStructure;i++){
                if(CurTreeStructure[i].id == treeNode.id){
                    CurTreeStructure.remove(i);
                    break;
                }
            }
        },function(){

        });
    }

    /****新增节点*****/
    function addTreeNode () {
        TreeUtils.hideRMenu();
        var zTree = TreeUtils.zTree;
        var newNode = { name:"新主题" + (TreeUtils.addCount++)};
        if (zTree.getSelectedNodes()[0]) {
            newNode.checked = zTree.getSelectedNodes()[0].checked;
            newNode.parentId = zTree.getSelectedNodes()[0].id;
        }else{
            newNode.parentId = 0;
        }
        var structure = newNode;
        structure.treeId = CurTreeId;
        var url = Const.Api_URL + "/MyNoteController/updateStruct";
        View.post(url,structure,function(resp){
            newNode.id = resp.id;
            if(zTree.getSelectedNodes()[0]){
                zTree.addNodes(zTree.getSelectedNodes()[0], newNode);
            }else{
                zTree.addNodes(null, newNode);
            }
        },function(){

        });
    }

    /****删除节点*****/
    function removeTreeNode() {
        TreeUtils.hideRMenu();
        var zTree = TreeUtils.zTree;
        var nodes = zTree.getSelectedNodes();
        if (nodes && nodes.length>0) {
            if (nodes[0].children && nodes[0].children.length > 0) {
                var msg = "要删除的节点是父节点，如果删除将连同子节点一起删掉。\n\n请确认！";
                if (confirm(msg)==true){
                    zTree.removeNode(nodes[0]);
                }else{
                    return;
                }
            } else {
                zTree.removeNode(nodes[0]);
            }
        }
        afterRemove(zTree,TreeUtils.treeId,nodes);
    }

    /****右键的修改节点功能*****/
    function editTreeNode() {

    }

    /****移动节点*****/
    function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType,isCopy){
        if(!isCopy){//移动
            var structure = {};
            structure.id = treeNodes[0].id;
            structure.parentId = treeNodes[0].parentId;
            structure.name = treeNodes[0].name;
            structure.treeId = CurTreeId;
            var url = Const.Api_URL + "/MyNoteController/updateStruct";
            View.post(url,structure,function(resp){

            },function(){

            });
        }else{//复制

        }
    }

    /****点击节点，获取文章列表*****/
    function getDetailList(event, treeId, treeNode){
        CurNode = treeNode;
        var url = Const.Api_URL + "/MyNoteController/getAtcList";
        View.get(url,"id="+treeNode.id+"&treeId="+CurTreeId,function(resp){
            CurDetailList = resp;
            frushDetailTmpl();
        },function(){

        });
    }

    /*****控制tree列表是否可以维护*******/
    function controlTreeFun(){
        if(controlTree == 0){//解锁
            controlTree = 1;
            TreeUtils.init("treeDemo","rMenu",setting,CurTreeStructure);
            $("#lock-icon").attr("class","mdi mdi mdi-lock-open-outline");
        }else{
            //锁住
            controlTree = 0;
            TreeUtils.init("treeDemo","rMenu",setting_lock,CurTreeStructure);
            $("#lock-icon").attr("class","mdi mdi-lock-outline");
        }
    }

</script>
<script id="atcListTmpl" type="text/html">
    {{if list.length === 0}}
    <p class="note-atc-menu-desc" style="margin-left:80px">暂无记录</p>
    {{/if}}
    {{each list as item i}}
    <li id="li_{{i}}" class="list-group-item" onclick="getAtc('li_{{i}}',{{item.atcId}},{{item.type}})">
        <p class="note-atc-menu-title">{{item.titleInfo}}</p>
        <p class="note-atc-menu-date"> {{item.createTime}}</p>
        <p class="note-atc-menu-desc">{{item.description}}</p>
    </li>
    {{/each}}
</script>
<script id="atcTmpl" type="text/html">
    <div class="form-inline row">
        <div style="float:left;width:100%;">
            <div style="margin-right:200px;">
                <input id="titleInfo" readOnly="true" style="width:100%;background-color:transparent;border:0;" type="text" placeholder="Title..." class="form-control" value="{{data.titleInfo}}">
            </div>
        </div>
        <div style="position:fixed;right:0;margin-top: 7px;margin-bottom: 7px;width:200px;">
            <button class="btn-rounded w-xs btn btn-default waves-effect waves-light" onclick="hideToolbar()">
                <i class="mdi mdi-lock-outline"></i>
                <span style="font-size:x-small">编辑</span>
            </button>
            <a data-container="body" data-placement="bottom" data-toggle="popover" title=""
               data-content="<h4>标签</h4>"
               style="margin-left: 10px;margin-top:10px;text-decoration:none;">
                <i class="mdi mdi-tag-outline"></i>
            </a>
            <a data-container="body" data-placement="bottom" data-toggle="popover" title=""
               data-content="<h4>信息概要</h4>" style="text-decoration:none;">
                <i class="mdi mdi-information-outline"></i>
            </a>
            <a data-container="body" data-placement="bottom" data-toggle="popover" title=""
               data-content="<h4>全屏</h4>" style="text-decoration:none;">
                <i class="mdi mdi-arrow-expand-all"></i>
            </a>
            <a data-container="body" data-placement="bottom" data-toggle="popover" title=""
               data-content="<h4>评论</h4>" style="text-decoration:none;">
                <i class="mdi mdi-comment-processing-outline"></i>
            </a>
        </div>
    </div>
    <div id="atcDesc" style="height: 88px">
        <div class="alert alert-info" role="alert">
            <span>{{data.description}}</span>
        </div>
    </div>
    <div class="summernote"></div>
</script>
</html>
